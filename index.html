<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CodeNThusiast</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center mb-6">ðŸš€ CodeNThusiast</h1>

    <!-- Auth Section -->
    <div id="authSection" class="text-center">
      <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Sign In with Google</button>
      <button id="logoutBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <!-- New Post Section -->
    <div id="postSection" class="hidden mt-6 bg-white p-4 rounded shadow">
      <textarea id="postContent" class="w-full p-2 border rounded" placeholder="Share your project..."></textarea>
      <button id="postBtn" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Post</button>
    </div>

    <!-- Search Section -->
    <div id="searchSection" class="hidden mt-6 bg-white p-4 rounded shadow">
      <input id="searchInput" type="text" class="w-full p-2 border rounded" placeholder="Search coders by email...">
      <div id="searchResults" class="mt-2"></div>
    </div>

    <!-- Following Tab -->
    <div id="tabs" class="hidden mt-6 flex gap-4">
      <button id="allPostsTab" class="px-4 py-2 bg-blue-500 text-white rounded">All Posts</button>
      <button id="followingTab" class="px-4 py-2 bg-gray-500 text-white rounded">Following</button>
    </div>

    <!-- Posts Feed -->
    <div id="posts" class="mt-6 space-y-4"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ðŸ”¹ Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDCzuCqNWUU3aZh5CBBA9Sq7lRchkBgBt4",
      authDomain: "codenthusiast-d4e21.firebaseapp.com",
      projectId: "codenthusiast-d4e21",
      storageBucket: "codenthusiast-d4e21.firebasestorage.app",
      messagingSenderId: "1098736253424",
      appId: "1:1098736253424:web:0813491a1279ca7ada8535",
      measurementId: "G-C88NVCTDMV"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const postSection = document.getElementById("postSection");
    const postBtn = document.getElementById("postBtn");
    const postsDiv = document.getElementById("posts");
    const searchSection = document.getElementById("searchSection");
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const tabs = document.getElementById("tabs");
    const allPostsTab = document.getElementById("allPostsTab");
    const followingTab = document.getElementById("followingTab");

    let currentUser = null;
    let following = [];

    // ðŸ”¹ Login
    loginBtn.onclick = async () => {
      const result = await signInWithPopup(auth, provider);
      currentUser = result.user;

      // Save user to Firestore
      await setDoc(doc(db, "users", currentUser.uid), {
        email: currentUser.email,
        displayName: currentUser.displayName
      }, { merge: true });

      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      postSection.classList.remove("hidden");
      searchSection.classList.remove("hidden");
      tabs.classList.remove("hidden");

      loadPosts();
    };

    // ðŸ”¹ Logout
    logoutBtn.onclick = async () => {
      await signOut(auth);
      currentUser = null;
      loginBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      postSection.classList.add("hidden");
      searchSection.classList.add("hidden");
      tabs.classList.add("hidden");
      postsDiv.innerHTML = "";
    };

    // ðŸ”¹ Create Post
    postBtn.onclick = async () => {
      const content = document.getElementById("postContent").value;
      if (!content) return;
      await addDoc(collection(db, "posts"), {
        uid: currentUser.uid,
        author: currentUser.displayName,
        email: currentUser.email,
        content,
        createdAt: Date.now()
      });
      document.getElementById("postContent").value = "";
      loadPosts();
    };

    // ðŸ”¹ Load Posts
    async function loadPosts(followingOnly = false) {
      postsDiv.innerHTML = "";
      let q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);

      snapshot.forEach(docSnap => {
        const post = docSnap.data();

        if (followingOnly && !following.includes(post.uid)) return;

        const postDiv = document.createElement("div");
        postDiv.className = "p-4 bg-white rounded shadow";

        postDiv.innerHTML = `
          <div class="flex justify-between">
            <div>
              <strong>${post.author}</strong> <small class="text-gray-500">(${post.email})</small>
            </div>
            ${currentUser && post.uid === currentUser.uid ? 
              `<button class="text-red-500" data-id="${docSnap.id}">Delete</button>` : ""}
          </div>
          <p class="mt-2">${post.content}</p>
        `;

        // Delete functionality
        if (currentUser && post.uid === currentUser.uid) {
          postDiv.querySelector("button").onclick = async () => {
            await deleteDoc(doc(db, "posts", docSnap.id));
            loadPosts(followingOnly);
          };
        }

        postsDiv.appendChild(postDiv);
      });
    }

    // ðŸ”¹ Search Coders
    searchInput.oninput = async () => {
      searchResults.innerHTML = "";
      const queryText = searchInput.value.toLowerCase();
      if (!queryText) return;

      const snapshot = await getDocs(collection(db, "users"));
      snapshot.forEach(docSnap => {
        const user = docSnap.data();
        if (user.email.toLowerCase().includes(queryText)) {
          const div = document.createElement("div");
          div.className = "p-2 border-b flex justify-between";
          div.innerHTML = `
            <span>${user.displayName} (${user.email})</span>
            <button class="text-blue-600" data-id="${docSnap.id}">Follow</button>
          `;
          div.querySelector("button").onclick = async () => {
            following.push(docSnap.id);
            await setDoc(doc(db, "following", currentUser.uid), { list: following });
            alert("Followed " + user.displayName);
          };
          searchResults.appendChild(div);
        }
      });
    };

    // ðŸ”¹ Tabs
    allPostsTab.onclick = () => loadPosts(false);
    followingTab.onclick = () => loadPosts(true);

  </script>
</body>
</html>
