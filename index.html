<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Community Projects</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:20px; background:#f7fafc; color:#0f172a; }
    .container{max-width:900px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    button{background:#0f172a;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .card{background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 1px 4px rgba(2,6,23,0.06)}
    form input, form textarea { width:100%; padding:8px; border-radius:6px; border:1px solid #e6e9ef; margin-top:6px; }
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    img.preview{max-width:100%;border-radius:8px;margin-top:8px}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1 style="margin:0">Community Projects</h1>
        <div class="small">Sign in, upload your project, and browse others</div>
      </div>
      <div>
        <div id="userArea" style="display:flex;gap:8px;align-items:center">
          <span id="userName" class="small"></span>
          <button id="authBtn">Sign in</button>
        </div>
      </div>
    </header>

    <section class="card" id="uploadCard" style="display:none">
      <h3 style="margin-top:0">Upload a project</h3>
      <form id="projectForm">
        <label>Title</label>
        <input id="title" required placeholder="Project title" />
        <label>Description</label>
        <textarea id="description" rows="4" placeholder="Short description"></textarea>
        <label>Image (optional)</label>
        <input id="image" type="file" accept="image/*" />
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <button type="submit">Upload project</button>
          <div id="uploadStatus" class="small" style="color:#666"></div>
        </div>
      </form>
    </section>

    <section>
      <h2 style="margin-bottom:6px">Projects</h2>
      <div id="projects" class="grid"></div>
    </section>

    <footer style="margin-top:20px" class="small">Built with Firebase â€¢ Make sure you pasted your firebaseConfig (see instructions)</footer>
  </div>

  <!-- Firebase v9 modular via CDN (uses ES modules) -->
  <script type="module">
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDCzuCqNWUU3aZh5CBBA9Sq7lRchkBgBt4",
  authDomain: "codenthusiast-d4e21.firebaseapp.com",
  projectId: "codenthusiast-d4e21",
  storageBucket: "codenthusiast-d4e21.firebasestorage.app",
  messagingSenderId: "1098736253424",
  appId: "1:1098736253424:web:0813491a1279ca7ada8535",
  measurementId: "G-C88NVCTDMV"

    };
    // =====================================================

    // If user forgets to paste config, show message and stop:
    if (!firebaseConfig || !firebaseConfig.apiKey) {
      document.body.insertAdjacentHTML('afterbegin',
        '<div style="background:#fee2e2;color:#9b1c1c;padding:12px;text-align:center">ðŸ”¥ You must paste your Firebase config into this file. See setup steps above.</div>');
      throw new Error('Missing firebaseConfig');
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // ui elements
    const authBtn = document.getElementById('authBtn');
    const userName = document.getElementById('userName');
    const uploadCard = document.getElementById('uploadCard');
    const projectForm = document.getElementById('projectForm');
    const projectsDiv = document.getElementById('projects');
    const uploadStatus = document.getElementById('uploadStatus');

    let currentUser = null;

    authBtn.addEventListener('click', async () => {
      if (currentUser) {
        await signOut(auth);
      } else {
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          alert('Sign-in failed: ' + e.message);
        }
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        userName.textContent = user.displayName || user.email;
        authBtn.textContent = 'Sign out';
        uploadCard.style.display = 'block';
      } else {
        userName.textContent = '';
        authBtn.textContent = 'Sign in';
        uploadCard.style.display = 'none';
      }
    });

    // realtime projects listener
    const projectsCol = collection(db, 'projects');
    const q = query(projectsCol, orderBy('createdAt', 'desc'));
    onSnapshot(q, snapshot => {
      projectsDiv.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">${escapeHtml(data.title || '(no title)')}</div>
            <div class="small">${(data.authorName || 'Anonymous')}</div>
          </div>
          <div class="small" style="margin-top:6px">${escapeHtml(data.description || '')}</div>
          ${data.imageUrl ? `<img src="${escapeAttr(data.imageUrl)}" class="preview" alt="project image">` : ''}
          <div class="small" style="margin-top:8px;color:#888">${new Date((data.createdAt && data.createdAt.seconds ? data.createdAt.seconds*1000 : Date.now())).toLocaleString()}</div>
        `;
        projectsDiv.appendChild(el);
      });
    });

    // handle project uploads
    projectForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) { alert('Please sign-in first'); return; }
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const imageInput = document.getElementById('image');
      uploadStatus.textContent = 'Uploading...';

      try {
        let imageUrl = '';
        if (imageInput.files && imageInput.files[0]) {
          const file = imageInput.files[0];
          const path = `projects/${currentUser.uid}/${Date.now()}_${file.name}`;
          const sRef = storageRef(storage, path);
          await uploadBytes(sRef, file);
          imageUrl = await getDownloadURL(sRef);
        }

        await addDoc(projectsCol, {
          title,
          description,
          imageUrl,
          authorName: currentUser.displayName || currentUser.email,
          uid: currentUser.uid,
          createdAt: serverTimestamp()
        });

        uploadStatus.textContent = 'Uploaded âœ“';
        projectForm.reset();
        setTimeout(()=>uploadStatus.textContent='', 2000);
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = 'Error: ' + (err.message || err);
      }
    });

    // small helpers
    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeAttr(s){ return s ? s.replace(/"/g, '&quot;') : s; }

  </script>
</body>
</html>
