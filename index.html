<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CodeNThusiast — Community</title>
  <!-- Tailwind (quick styling) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small visual niceties */
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card { background: white; border-radius: .6rem; box-shadow: 0 6px 18px rgba(2,6,23,0.06); padding: 1rem; }
    .avatar { width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#0369a1);color:white;font-weight:700;display:grid;place-items:center; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-sky-600 flex items-center justify-center text-white font-bold">CN</div>
        <div>
          <h1 class="text-2xl font-bold">CodeNThusiast — Community</h1>
          <div class="text-sm text-slate-600">Sign in, upload projects, follow coders, and browse work.</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <input id="coderSearch" placeholder="Search coders..." class="hidden md:inline-block px-3 py-2 rounded-lg border bg-white" />
        <button id="searchBtn" class="px-3 py-2 rounded-lg bg-white border hidden md:inline-block">Search</button>

        <div id="authStatus" class="flex items-center gap-2"></div>
        <button id="authBtn" class="px-3 py-2 rounded-lg bg-sky-600 text-white">Sign in</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="flex gap-3 mb-6">
      <button id="tabAll" class="px-3 py-2 rounded-md bg-white border">All</button>
      <button id="tabFollowing" class="px-3 py-2 rounded-md bg-white border">Following</button>
      <button id="tabMy" class="px-3 py-2 rounded-md bg-white border">My uploads</button>
    </nav>

    <!-- Uploader -->
    <section id="uploader" class="card mb-6 hidden">
      <div class="flex items-start gap-4 mb-3">
        <div id="uAvatar" class="avatar">U</div>
        <div class="flex-1">
          <div class="text-sm text-slate-600 mb-2">Signed in as <span id="uName" class="font-semibold"></span></div>
          <form id="projectForm" class="space-y-3">
            <div><input id="title" placeholder="Project title" class="w-full px-3 py-2 border rounded-lg" required /></div>
            <div><textarea id="description" placeholder="Short description" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea></div>
            <div><input id="image" type="file" accept="image/*" class="w-full" /></div>
            <div class="flex items-center gap-3">
              <button id="uploadBtn" class="px-3 py-2 rounded-md bg-sky-600 text-white">Upload project</button>
              <div id="uploadStatus" class="text-sm text-slate-600"></div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Feed -->
    <section>
      <div id="feed" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <!-- Coders results -->
    <section id="coders" class="mt-6"></section>

    <footer class="mt-8 text-sm text-slate-500">Built with Firebase • Make sure your Firebase auth & domains are configured (see instructions)</footer>
  </div>

  <!-- Firebase modular imports -->
  <script type="module">
    // -----------------------
    // CONFIG — your firebase config (fixed storageBucket)
    // -----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDCzuCqNWUU3aZh5CBBA9Sq7lRchkBgBt4",
      authDomain: "codenthusiast-d4e21.firebaseapp.com",
      projectId: "codenthusiast-d4e21",
      storageBucket: "codenthusiast-d4e21.appspot.com", // <-- fixed
      messagingSenderId: "1098736253424",
      appId: "1:1098736253424:web:0813491a1279ca7ada8535",
      measurementId: "G-C88NVCTDMV"
    };

    // safety check
    if (!firebaseConfig || !firebaseConfig.apiKey) {
      alert('Missing firebaseConfig - paste your Firebase settings into the file.');
      throw new Error('Missing firebaseConfig');
    }

    // imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, getDocs,
      query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc,
      where, serverTimestamp, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI refs
    const authBtn = document.getElementById('authBtn');
    const authStatus = document.getElementById('authStatus');
    const uploader = document.getElementById('uploader');
    const uAvatar = document.getElementById('uAvatar');
    const uName = document.getElementById('uName');
    const projectForm = document.getElementById('projectForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const feed = document.getElementById('feed');
    const coders = document.getElementById('coders');
    const coderSearch = document.getElementById('coderSearch');
    const searchBtn = document.getElementById('searchBtn');
    const tabAll = document.getElementById('tabAll');
    const tabFollowing = document.getElementById('tabFollowing');
    const tabMy = document.getElementById('tabMy');

    // state
    let currentUser = null;
    let usersCache = {}; // uid -> user doc
    let allProjects = []; // cached
    let currentTab = 'all'; // all | following | mine | profile
    let viewingUid = null;

    // Prevent double login popup
    let loginInProgress = false;
    authBtn.addEventListener('click', async () => {
      if (currentUser) {
        // sign out
        try {
          await signOut(auth);
        } catch(e){ console.error('signout failed', e); alert('Sign out failed'); }
        return;
      }
      if (loginInProgress) return;
      loginInProgress = true;
      authBtn.disabled = true;
      try {
        await signInWithPopup(auth, provider);
        // onAuthStateChanged will run after successful sign in
      } catch(err) {
        console.error('Sign-in error', err);
        // Ignore popup-cancel by user; show serious errors
        if (err.code && err.code !== 'auth/cancelled-popup-request' && err.code !== 'auth/popup-closed-by-user') {
          alert('Sign-in failed: ' + (err.message || err.code));
        }
      } finally {
        loginInProgress = false;
        authBtn.disabled = false;
      }
    });

    // track auth state
    onAuthStateChanged(auth, async (user) => {
      console.log('Auth state changed:', user);
      if (user) {
        currentUser = user;
        // ensure user doc
        try {
          const uDocRef = doc(db, 'users', user.uid);
          const uSnap = await getDoc(uDocRef);
          if (!uSnap.exists()) {
            await setDoc(uDocRef, {
              displayName: user.displayName || user.email,
              email: user.email,
              photoURL: user.photoURL || '',
              following: [],
              createdAt: serverTimestamp()
            });
          } else {
            // merge name/email in case changed
            await setDoc(uDocRef, {
              displayName: user.displayName || user.email,
              email: user.email,
              photoURL: user.photoURL || ''
            }, { merge: true });
          }
        } catch(e){ consol
